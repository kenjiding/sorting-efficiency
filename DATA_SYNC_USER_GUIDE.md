# 数据同步使用指南

## 快速开始

### 1. 设置Token

在使用数据同步功能前，需要先配置外部API的Token：

1. 点击右上角的设置图标
2. 进入"Token管理"
3. 输入您的JWT Token
4. 点击"保存"

### 2. 同步数据

#### 方式一：全局同步（推荐）

在"数据报表看板"页面（/dashboard），点击右上角的**"同步最新数据"**按钮：

- 一键同步所有数据模块（货量数据 + 问题件数据）
- 自动检测上次同步日期，只同步新增数据
- 显示上次同步的最新数据日期
- 同步完成后会显示成功提示

#### 方式二：单独同步

在各个数据模块中，也可以单独同步该模块的数据（如果需要）。

### 3. 查看数据

同步完成后，数据会自动从本地MongoDB数据库读取，查询速度快，无需等待外部API响应。

## 功能说明

### 增量同步

系统会自动记录上次同步的日期，每次点击同步时：

- **如果是首次同步**：同步最近7天的数据
- **如果已同步过**：只同步从上次同步日期后的新数据

**示例：**
- 今天是 2025年12月11日
- 上次同步日期是 2025年12月1日
- 点击同步后，会同步 2025年12月2日 至 2025年12月11日 的数据（共10天）

### 数据去重

系统会自动去重，相同的运单号只保留一条记录，避免重复数据。

### 同步状态

在"同步最新数据"按钮下方，会显示同步状态：

- **🟢 最新数据: 2025-12-11** - 表示已同步到该日期
- **🟠 从未同步** - 表示该模块从未同步过
- **🔴 上次同步失败** - 表示上次同步遇到错误

## 涉及的数据模块

### 1. 货量数据

- **位置**：数据报表看板 → 货量数据
- **数据源**：https://ds.imile.com/lm/express/ops/v1/biz/inbound/query
- **包含**：运单号、扫描时间、路由编码
- **用途**：
  - 周期对比分析
  - 按供应商/路由码维度统计
  - 趋势图表展示

### 2. 问题件数量分析

- **位置**：数据报表看板 → 服务数据 → 问题件数量分析
- **数据源**：https://ds.imile.com/dms/migrate/biz/problem/audit/searchNew
- **包含**：运单号、供应商、司机、问题原因、登记时间
- **用途**：
  - 按供应商/司机/原因维度分析
  - 按天/周/月维度统计
  - 趋势图表展示

## 常见问题

### Q1: 同步需要多长时间？

**A:** 取决于需要同步的天数和数据量：
- 1天数据：约3-5秒
- 7天数据：约10-30秒
- 首次同步（7天）：约30-60秒

同步过程中请勿关闭页面。

### Q2: 为什么同步失败？

**可能的原因：**
1. **Token无效或过期** - 请重新设置Token
2. **网络连接问题** - 检查网络连接
3. **外部API限流** - 稍后再试
4. **服务器问题** - 联系技术支持

**解决方法：**
1. 查看错误提示信息
2. 检查Token是否正确
3. 重试同步

### Q3: 如何知道数据是否是最新的？

**A:** 查看"同步最新数据"按钮下方的状态提示：
- 显示"最新数据: YYYY-MM-DD"表示已同步到该日期
- 如果该日期不是今天，说明需要重新同步

### Q4: 能否重新同步某天的数据？

**A:** 当前系统使用增量同步，不会重复同步已有数据。如需重新同步：
1. 联系技术人员清除相关日期的数据
2. 重新执行同步

### Q5: 数据查询为什么比以前快？

**A:** 以前是每次查询都要等待外部API响应（可能需要10-30秒），现在数据已经同步到本地MongoDB，查询只需要1-2秒。

### Q6: 多久需要同步一次？

**建议：**
- **每天早上**：同步前一天的数据
- **需要查看最新数据时**：随时点击同步
- **首次使用**：先执行一次同步

### Q7: 同步会影响其他用户吗？

**A:** 不会。数据同步是后台操作，同步期间其他用户仍可正常使用系统。

## 技术细节（给开发者）

### 同步流程

```
1. 前端点击同步按钮
   ↓
2. 调用后端同步API（携带Token）
   ↓
3. 后端查询上次同步日期
   ↓
4. 计算需要同步的日期范围
   ↓
5. 分批调用外部API获取数据
   ↓
6. 批量插入MongoDB（自动去重）
   ↓
7. 更新同步元数据
   ↓
8. 返回同步结果
```

### 数据存储

- **MongoDB集合**：
  - `syncmetadatas` - 同步元数据（记录上次同步时间）
  - `inboundscanrecords` - 货量数据
  - `problemitems` - 问题件数据

- **去重机制**：使用运单号（`waybillNumber`）作为唯一标识

### API端点

- `GET /api/sync/status` - 获取同步状态
- `POST /api/sync/inbound` - 同步货量数据
- `POST /api/sync/problem-items` - 同步问题件数据
- `POST /api/sync/all` - 全量同步

## 更新日志

### 2025-12-11 v1.0

**新增功能：**
- ✅ 一键数据同步功能
- ✅ 增量同步机制
- ✅ 自动去重处理
- ✅ 同步状态显示
- ✅ 批量数据处理
- ✅ 详细的同步日志

**改进：**
- ⚡ 查询速度提升10倍（从10-30秒降至1-2秒）
- 🚫 移除7天时间范围限制（现在可以查询任意时间范围）
- 📊 本地数据库存储，离线也能查看历史数据

**涉及模块：**
- 货量数据模块
- 问题件数量分析模块

**后续计划：**
- 🔄 自动定时同步
- 📱 同步进度实时显示
- 🔔 同步完成通知
- 📈 丢包分析模块（复用同步架构）
- 📈 客诉分析模块（复用同步架构）

## 联系支持

如有问题或建议，请联系技术支持团队。
